name: Deploy to GitHub Pages

on:
    push:
        branches:
            - master
            - main
    pull_request:
        branches:
            - master
            - main

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest

        permissions:
            contents: read
            pages: write
            id-token: write

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "24"
                  cache: "npm"

            - name: Generate file structure hash
              id: file-structure
              run: |
                  # ç”ŸæˆåŒ…å«æ–‡ä»¶è·¯å¾„å’Œå†…å®¹çš„ç»¼åˆå“ˆå¸Œ
                  STRUCTURE_HASH=$(find public/assets -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.gif" -o -name "*.webp" \) -exec echo {} \; | sort | sha256sum | cut -d' ' -f1)
                  CONTENT_HASH=${{ hashFiles('public/assets/**/*.png', 'public/assets/**/*.jpg', 'public/assets/**/*.gif', 'public/assets/**/*.webp') }}
                  SCRIPT_HASH=${{ hashFiles('scripts/generate-thumbnails.cjs') }}
                  COMBINED_HASH=$(echo "${STRUCTURE_HASH}-${CONTENT_HASH}-${SCRIPT_HASH}" | sha256sum | cut -d' ' -f1)
                  echo "structure-hash=${STRUCTURE_HASH}" >> $GITHUB_OUTPUT
                  echo "content-hash=${CONTENT_HASH}" >> $GITHUB_OUTPUT
                  echo "script-hash=${SCRIPT_HASH}" >> $GITHUB_OUTPUT
                  echo "combined-hash=${COMBINED_HASH}" >> $GITHUB_OUTPUT
                  echo "ğŸ“Š æ–‡ä»¶ç»“æ„å“ˆå¸Œ: ${STRUCTURE_HASH}"
                  echo "ğŸ“Š æ–‡ä»¶å†…å®¹å“ˆå¸Œ: ${CONTENT_HASH}"
                  echo "ğŸ“Š è„šæœ¬å“ˆå¸Œ: ${SCRIPT_HASH}"
                  echo "ğŸ“Š ç»¼åˆå“ˆå¸Œ: ${COMBINED_HASH}"

            - name: Restore thumbnail cache file
              uses: actions/cache/restore@v4
              id: cache-thumbnail-cache
              with:
                  path: .thumbnail-cache.json
                  key: thumbnail-cache-v3-${{ steps.file-structure.outputs.combined-hash }}
                  restore-keys: |
                      thumbnail-cache-v3-
                      thumbnail-cache-v2-
                      thumbnail-cache-

            - name: Restore generated thumbnails
              uses: actions/cache/restore@v4
              id: cache-thumbnails
              with:
                  path: public/assets/thumbnails
                  key: thumbnails-v3-${{ steps.file-structure.outputs.combined-hash }}
                  restore-keys: |
                      thumbnails-v3-
                      thumbnails-v2-
                      thumbnails-v1-
                      thumbnails-

            - name: Install dependencies
              run: npm ci

            - name: Create thumbnails directory if not exists
              run: mkdir -p public/assets/thumbnails

            - name: Generate thumbnails and check changes
              id: generate-and-check
              run: |
                  CACHE_HIT="${{ steps.cache-thumbnail-cache.outputs.cache-hit }}"
                  THUMBS_HIT="${{ steps.cache-thumbnails.outputs.cache-hit }}"
                  CACHE_KEY="${{ steps.cache-thumbnail-cache.outputs.cache-matched-key }}"
                  THUMBS_KEY="${{ steps.cache-thumbnails.outputs.cache-matched-key }}"

                  echo "ğŸ” ç¼“å­˜çŠ¶æ€æ£€æŸ¥ï¼š"
                  echo "   ç¼“å­˜æ–‡ä»¶å‘½ä¸­: ${CACHE_HIT}"
                  echo "   ç¼©ç•¥å›¾å‘½ä¸­: ${THUMBS_HIT}"
                  echo "   ç¼“å­˜æ–‡ä»¶åŒ¹é…é”®: ${CACHE_KEY:-'æ— '}"
                  echo "   ç¼©ç•¥å›¾åŒ¹é…é”®: ${THUMBS_KEY:-'æ— '}"
                  echo "   å½“å‰ç»¼åˆå“ˆå¸Œ: ${{ steps.file-structure.outputs.combined-hash }}"

                  # è®°å½•ç”Ÿæˆå‰çš„çŠ¶æ€
                  CACHE_BEFORE=""
                  THUMBS_BEFORE=""
                  [ -f ".thumbnail-cache.json" ] && CACHE_BEFORE=$(sha256sum .thumbnail-cache.json | cut -d' ' -f1)
                  [ -d "public/assets/thumbnails" ] && THUMBS_BEFORE=$(find public/assets/thumbnails -type f -exec sha256sum {} \; 2>/dev/null | sort | sha256sum | cut -d' ' -f1)

                  echo "   ç¼“å­˜æ–‡ä»¶å“ˆå¸Œ(å‰): ${CACHE_BEFORE:-'æ— '}"
                  echo "   ç¼©ç•¥å›¾å“ˆå¸Œ(å‰): ${THUMBS_BEFORE:-'æ— '}"

                  # ç”Ÿæˆç¼©ç•¥å›¾
                  npm run generate-thumbnails

                  # æ£€æŸ¥ç”Ÿæˆåçš„çŠ¶æ€
                  CACHE_AFTER=""
                  THUMBS_AFTER=""
                  [ -f ".thumbnail-cache.json" ] && CACHE_AFTER=$(sha256sum .thumbnail-cache.json | cut -d' ' -f1)
                  [ -d "public/assets/thumbnails" ] && THUMBS_AFTER=$(find public/assets/thumbnails -type f -exec sha256sum {} \; 2>/dev/null | sort | sha256sum | cut -d' ' -f1)

                  echo "   ç¼“å­˜æ–‡ä»¶å“ˆå¸Œ(å): ${CACHE_AFTER:-'æ— '}"
                  echo "   ç¼©ç•¥å›¾å“ˆå¸Œ(å): ${THUMBS_AFTER:-'æ— '}"

                  # åˆ¤æ–­ç¼“å­˜æ–‡ä»¶æ˜¯å¦éœ€è¦ä¿å­˜
                  EXPECTED_CACHE_KEY="thumbnail-cache-v3-${{ steps.file-structure.outputs.combined-hash }}"
                  if [ "$CACHE_KEY" != "$EXPECTED_CACHE_KEY" ] || [ "$CACHE_AFTER" != "$CACHE_BEFORE" ]; then
                    echo "thumbnail-cache-needs-save=true" >> $GITHUB_OUTPUT
                    if [ "$CACHE_KEY" != "$EXPECTED_CACHE_KEY" ]; then
                      echo "âœ… ç¼“å­˜æ–‡ä»¶éœ€è¦ä¿å­˜ï¼ˆç¼“å­˜é”®ä¸åŒ¹é…: ${CACHE_KEY} != ${EXPECTED_CACHE_KEY}ï¼‰"
                    else
                      echo "âœ… ç¼“å­˜æ–‡ä»¶éœ€è¦ä¿å­˜ï¼ˆç”Ÿæˆè¿‡ç¨‹ä¸­å†…å®¹å·²æ›´æ–°ï¼‰"
                    fi
                  else
                    echo "thumbnail-cache-needs-save=false" >> $GITHUB_OUTPUT
                    echo "â­ï¸  ç¼“å­˜æ–‡ä»¶æ— éœ€ä¿å­˜ï¼ˆå®Œå…¨åŒ¹é…ä¸”æ— å˜åŒ–ï¼‰"
                  fi

                  # åˆ¤æ–­ç¼©ç•¥å›¾æ˜¯å¦éœ€è¦ä¿å­˜
                  EXPECTED_THUMBS_KEY="thumbnails-v3-${{ steps.file-structure.outputs.combined-hash }}"
                  if [ "$THUMBS_KEY" != "$EXPECTED_THUMBS_KEY" ] || [ "$THUMBS_AFTER" != "$THUMBS_BEFORE" ]; then
                    echo "thumbnails-needs-save=true" >> $GITHUB_OUTPUT
                    if [ "$THUMBS_KEY" != "$EXPECTED_THUMBS_KEY" ]; then
                      echo "âœ… ç¼©ç•¥å›¾éœ€è¦ä¿å­˜ï¼ˆç¼“å­˜é”®ä¸åŒ¹é…: ${THUMBS_KEY} != ${EXPECTED_THUMBS_KEY}ï¼‰"
                    else
                      echo "âœ… ç¼©ç•¥å›¾éœ€è¦ä¿å­˜ï¼ˆç”Ÿæˆè¿‡ç¨‹ä¸­å†…å®¹å·²æ›´æ–°ï¼‰"
                    fi
                  else
                    echo "thumbnails-needs-save=false" >> $GITHUB_OUTPUT
                    echo "â­ï¸  ç¼©ç•¥å›¾æ— éœ€ä¿å­˜ï¼ˆå®Œå…¨åŒ¹é…ä¸”æ— å˜åŒ–ï¼‰"
                  fi

            - name: Build
              run: npm run build

            - name: Save thumbnail cache file
              uses: actions/cache/save@v4
              if: github.event_name == 'push' && steps.generate-and-check.outputs.thumbnail-cache-needs-save == 'true'
              with:
                  path: .thumbnail-cache.json
                  key: thumbnail-cache-v3-${{ steps.file-structure.outputs.combined-hash }}

            - name: Save generated thumbnails
              uses: actions/cache/save@v4
              if: github.event_name == 'push' && steps.generate-and-check.outputs.thumbnails-needs-save == 'true'
              with:
                  path: public/assets/thumbnails
                  key: thumbnails-v3-${{ steps.file-structure.outputs.combined-hash }}

            - name: Verify cache save
              if: github.event_name == 'push'
              run: |
                  echo "=== ç¼“å­˜ä¿å­˜ç¡®è®¤ ==="
                  echo "å½“å‰æ„å»ºå®Œæˆï¼Œç¼“å­˜çŠ¶æ€ï¼š"
                  echo ""
                  echo "ğŸ”‘ ç¼“å­˜é”®ä¿¡æ¯ï¼š"
                  echo "   æ–‡ä»¶ç»“æ„å“ˆå¸Œ: ${{ steps.file-structure.outputs.structure-hash }}"
                  echo "   æ–‡ä»¶å†…å®¹å“ˆå¸Œ: ${{ steps.file-structure.outputs.content-hash }}"
                  echo "   è„šæœ¬å“ˆå¸Œ: ${{ steps.file-structure.outputs.script-hash }}"
                  echo "   ç»¼åˆå“ˆå¸Œ: ${{ steps.file-structure.outputs.combined-hash }}"
                  echo ""

                  # æ£€æŸ¥ç¼“å­˜æ–‡ä»¶çŠ¶æ€
                  if [ -f ".thumbnail-cache.json" ]; then
                    echo "âœ… ç¼“å­˜æ–‡ä»¶å·²ç”Ÿæˆ: $(wc -l < .thumbnail-cache.json) è¡Œ"
                    if [ "${{ steps.generate-and-check.outputs.thumbnail-cache-needs-save }}" = "true" ]; then
                      echo "ğŸ“¤ ç¼“å­˜æ–‡ä»¶å·²ä¸Šä¼ åˆ° GitHub Actions ç¼“å­˜"
                      echo "   ç¼“å­˜é”®: thumbnail-cache-v3-${{ steps.file-structure.outputs.combined-hash }}"
                    else
                      echo "â­ï¸  ç¼“å­˜æ–‡ä»¶æœªå˜åŒ–ï¼Œè·³è¿‡ä¸Šä¼ "
                    fi
                  else
                    echo "âŒ ç¼“å­˜æ–‡ä»¶æœªç”Ÿæˆ"
                  fi

                  # æ£€æŸ¥ç¼©ç•¥å›¾çŠ¶æ€
                  if [ -d "public/assets/thumbnails" ] && [ "$(find public/assets/thumbnails -type f | wc -l)" -gt 0 ]; then
                    echo "âœ… ç¼©ç•¥å›¾å·²ç”Ÿæˆ: $(find public/assets/thumbnails -type f | wc -l) ä¸ªæ–‡ä»¶"
                    if [ "${{ steps.generate-and-check.outputs.thumbnails-needs-save }}" = "true" ]; then
                      echo "ğŸ“¤ ç¼©ç•¥å›¾å·²ä¸Šä¼ åˆ° GitHub Actions ç¼“å­˜"
                      echo "   ç¼“å­˜é”®: thumbnails-v3-${{ steps.file-structure.outputs.combined-hash }}"
                    else
                      echo "â­ï¸  ç¼©ç•¥å›¾æœªå˜åŒ–ï¼Œè·³è¿‡ä¸Šä¼ "
                    fi
                  else
                    echo "âŒ ç¼©ç•¥å›¾æœªç”Ÿæˆæˆ–ä¸ºç©º"
                  fi

                  echo ""
                  echo "=== ç¼“å­˜å†³ç­–æ‘˜è¦ ==="
                  echo "ç¼©ç•¥å›¾ç¼“å­˜æ–‡ä»¶ä¸Šä¼ : ${{ steps.generate-and-check.outputs.thumbnail-cache-needs-save }}"
                  echo "ç¼©ç•¥å›¾æ–‡ä»¶ä¸Šä¼ : ${{ steps.generate-and-check.outputs.thumbnails-needs-save }}"
                  echo "æ”¹è¿›è¯´æ˜: ç°åœ¨ç¼“å­˜é”®åŒ…å«æ–‡ä»¶è·¯å¾„ç»“æ„ï¼Œæ–‡ä»¶é‡å‘½å/ç§»åŠ¨æ—¶ä¼šæ­£ç¡®æ›´æ–°ç¼“å­˜"

            - name: Setup Pages
              if: github.event_name == 'push'
              uses: actions/configure-pages@v4

            - name: Upload artifact
              if: github.event_name == 'push'
              uses: actions/upload-pages-artifact@v3
              with:
                  path: ./dist

            - name: Deploy to GitHub Pages
              if: github.event_name == 'push'
              id: deployment
              uses: actions/deploy-pages@v4
